!function(e){function l(){e("#publish, #save-post").on("click",function(){u=!1}),e("#snowball-toolbar").on("click",".button",function(){var l=e(this).data("type");o(l),u=!0}).on("click",".tag",function(){var l=e(this).attr("data-tag");e(".tag.active").removeClass("active"),e(this).addClass("active"),"all"===l?e("#snowball-toolbar .button").show():e("#snowball-toolbar .button").hide().filter("."+l).show()}).css("width",e("#snowball-toolbar").parent().width()).fixedsticky(),e("#snowball-main").on("render",".snowball-block",function(){var l=e(this);t(l)}).on("mousedown",".snowball-block",function(){e("#snowball-main").height(e("#snowball-main").height())}).on("mouseup",".snowball-block",function(){e("#snowball-main").height("auto")}).on("input change",".snowball-tinker input, .snowball-tinker textarea:not(.handsontableInput), .snowball-tinker select",w(function(){var l=e(this).closest(".snowball-block");l.trigger("render"),d(l),u=!0},250)).on("click",".snowball-delete",function(){var l=e(this).closest(".snowball-block");b(l),u=!0}).on("click",".snowball-zoom-toggle",function(){var l=e(this).closest(".snowball-block");l.find(".snowball-code").toggle(),l.find(".snowball-delete").toggle(),l.toggleClass("modal"),e("body").toggleClass("modal"),s(l),l.find(".CodeMirror").each(function(e,l){l.CodeMirror.refresh()})}).on("mouseover",".snowball-zoom-toggle",function(){var l=e(this).closest(".snowball-block");0===l.find(".snowball-code .CodeMirror").length&&i(l)}).sortable({axis:"y",containment:"#snowball-main",cancel:".snowball-block.modal, textarea, input, select, .handsontable, .CodeMirror",cursor:"move",tolerance:"pointer"}),e("body").on("click","#modal-bg",function(){e(".snowball-block.modal .snowball-zoom-toggle").click()}),e("body").on("keydown",function(l){27===l.keyCode&&e(".snowball-block.modal .snowball-zoom-toggle").click()}),e(window).resize(w(function(){s()},250)).resize(function(){var l=e(".fixedsticky");l.css("width",l.parent().width())}).on("beforeunload",function(e){return u?"You may have unsaved changes.":void 0}),e("#collapse-menu").click(function(){var l=e(".fixedsticky");l.css("width",l.parent().width()),s()})}function n(){for(var e in snowball.savedblocks){var l=snowball.savedblocks[e],n=l.blockType.toLowerCase();delete l.blockType,delete l.orderNumber,o(n,l)}}function o(l,n){var o=snowball.blocks[l],a=snowball.names[l],s=e("<div class='snowball-block'><div class='snowball-gui'><div class='snowball-tinker'><div><div class='snowball-title'></div><div class='snowball-title-button snowball-delete'>&times;</div><div class='snowball-title-button snowball-zoom-toggle'><i class='fa fa-code'></i></div></div></div><iframe class='snowball-preview'></iframe></div><div class='snowball-code'><div class='snowball-html snowball-editor'><div class='snowball-code-title'>HTML</div><textarea class='snowball-editor-box' data-mode='xml'></textarea></div><div class='snowball-css snowball-editor'><div class='snowball-code-title'>CSS</div><textarea class='snowball-editor-box' data-mode='css'></textarea></div></div></div>");if(s.addClass("snowball-block-"+l).attr("data-type",l).attr("data-name",a).find(".snowball-title").text(a).end().find(".snowball-tinker").append(o).end(),n)for(var i in n){if(n.hasOwnProperty(i)){var r="[data-target='"+i+"']",c=s.find(r),d=n[i];c&&(c.is(":radio")?c.filter("[value='"+d+"']").prop("checked",!0):c.is(":checkbox")?"true"==d?c.prop("checked",!0):c.prop("checked",!1):c.val(d))}n.customCss&&s.find("textarea[data-mode='css']").html(n.customCss)}else{var b={orderNumber:snowball.savedblocks.length,blockType:l};snowball.savedblocks.push(b)}s.find(".snowball-preview").load(function(){t(s)}).end().find(".wp-color-picker").wpColorPicker({change:w(function(l){e(this).trigger("change").attr("value",e(this).val())},250)}).end().appendTo("#snowball-main").trigger("open")}function t(l){var n=l.data("type"),o=l.find(".snowball-preview").contents(),t=snowball.templates[n],i="input[type='text'][data-target], input[type='email'][data-target], input[type='range'][data-target], input[type='hidden'][data-target], input[type='radio'][data-target]:checked, input[type='checkbox'][data-target]:checked, textarea[data-target], select[data-target]",r=l.find(i);r.each(function(l,o){var a=e(this).data("target"),s=e(this).val();"text"===n&&e(this).is("textarea")&&(s=s.replace(/(.+?)\n{2,}/g,"<p>$1</p>"));var i=new RegExp("{{"+a+"}}","g");t=t.replace(i,s)}),t=t.replace(/{{.+}}/g,""),t=t.replace(/\[author\]/g,snowball.author).replace(/\[blogname\]/g,snowball.blogname).replace(/\[blogurl\]/g,snowball.blogurl).replace(/\[date\]/g,snowball.date).replace(/\[url\]/g,snowball.url),snowball.title&&(t=t.replace(/\[title\]/g,snowball.title));var c=e(t),d=c.find("script").detach();o.find("body").empty().append(c),a(d,l),l.width()&&s(l),l.trigger("rendered")}function a(l,n){function o(e){var l=s.get(0).contentDocument.createElement("script");l.src=h[e],l.onload=e<h.length-1?function(){o(e+1)}:function(){t(0)},r[0].appendChild(l)}function t(e){if(e<l.length){var n=l.eq(e).attr("src"),o=s.get(0).contentDocument.createElement("script");n?(o.src=n,o.onload=function(){t(e+1)}):o.innerHTML=l.eq(e).html(),d.find(".snowball-block").get(0).appendChild(o)}}var a,s=n.find(".snowball-preview"),i=s.contents(),r=i.find("head"),d=i.find("body"),b=n.find(".snowball-code .CodeMirror"),w="",u=snowball.pluginsUrl,f=snowball.includesUrl;if(b.length){var p=b[1].CodeMirror;a=c(p)}else a=n.find("textarea[data-mode='css']").html();if(a){var m=e("<style></style>").attr({"data-type":"custom",scoped:"scoped"});m.html(a),d.find(".snowball-block").append(m)}var v=[u+"/lib/d3-geomap/css/d3.geomap.css",u+"/lib/font-awesome/css/font-awesome.min.css",u+"/styles/min/snowball.min.css",u+"/styles/min/snowball-preview.min.css"],h=[f+"js/jquery/jquery.js","https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js","https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js",u+"/lib/d3-geomap/vendor/d3.geomap.dependencies.min.js",u+"/lib/d3-geomap/js/d3.geomap.min.js",u+"/scripts/min/snowball-preview.min.js",u+"/scripts/min/templates.min.js"];v.forEach(function(e){var l="<link rel='stylesheet' href='"+e+"'>\n";w+=l}),r.is(":empty")&&(r.html("<meta charset='utf-8'>"),r.append(w),o(0))}function s(l){var n,o,t;l?(n=l.width()/2,o=800>n?n/800:1,t="scale("+o+")",l.find(".snowball-preview").contents().find("html").css({"-webkit-transform":t,transform:t})):e(".snowball-preview").each(function(){n=e(this).closest(".snowball-block").width()/2,o=800>n?n/800:1,t="scale("+o+")",e(this).contents().find("html").css({"-webkit-transform":t,transform:t})})}function i(l){var n=l.find(".snowball-preview").contents().find("body"),o=l.find(".snowball-editor-box");o.each(function(l,o){var a=e(o).attr("data-mode"),s="xml"===a?!0:!1,i=CodeMirror.fromTextArea(o,{mode:{name:a,htmlMode:!0},readOnly:s,lineNumbers:!0,lineWrapping:!0,theme:"monokai"});r(n,a,i),i.on("change",w(function(){var l=e(o).closest(".snowball-block");t(l),u=!0},250))})}function r(l,n,o,t){var a="",s=0;if("css"==n){l.find("style:not([data-type='custom'])").each(function(){a+=e(this).html()}),a?(a=a.replace(/^\n+|\n+$/g,""),a+="\n\n",s=a.split(/\r\n|\r|\n/).length-1):a="",t&&(a+=t);var i=c(o);i&&(a+=i)}else if("xml"===n){var r=l.clone();r.find("style").remove(),a=r.html().replace("\n\n</section>","\n</section>"),s=a.split(/\r\n|\r|\n/).length}var d=o.getCursor(),b=o.getScrollInfo().top,w={line:0,ch:0},u={line:s,ch:0},f={readOnly:!0,inclusiveLeft:!0};o.setValue(a),o.markText(w,u,f);for(var p=0;s>p;p++)o.addLineClass(p,"background","readonly");o.setCursor(d),o.scrollTo(null,b)}function c(e){var l=e.getAllMarks(),n=e.getValue();if(l.length){var o=l[0],t=o.lines.length;if(2>t)n=e.getValue();else{var a={line:t-1,ch:0},s={line:e.lastLine()+1,ch:0};n=e.getRange(a,s)}}return n}function d(e){var l=e.find(".snowball-code .CodeMirror");if(l.length){var n=l[0].CodeMirror,o=l[1].CodeMirror,t=e.find(".snowball-preview").contents().find("body");r(t,"xml",n),r(t,"css",o)}}function b(e){var l=confirm("Are you sure you want to delete this block?");l&&e.trigger("close").remove()}function w(e,l){var n=null;return function(){var o=this,t=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(o,t)},l)}}var u=!1;jQuery(document).ready(function(){l(),0!==snowball.savedblocks.length&&"null"!==snowball.savedblocks?(snowball.savedblocks=JSON.parse(snowball.savedblocks),n()):snowball.savedblocks=[]})}(jQuery);